\documentclass[10pt]{amsart}

\usepackage{amssymb,hyperref}
% \linespread{1.2}
\usepackage[
hmarginratio={1:1},     % equal left and right margins
vmarginratio={1:1},     % equal top and bottom margins
textwidth=400pt,        % new text width
heightrounded,          % always useful
%%bindingcorrection=5mm,  % binding correction
]{geometry}
%opening
\title{Fast 3D Node generation with variable density in Matlab}
\author{N.F., B.F., T.M., O.V.}
\date{\today}

\newcommand{\cube}{\mathcal{C}}

\begin{document}

\maketitle

\section{Overview}

The aim is to develop a method for distributing nodes on arbitrarily shaped domains in a way that would 
\begin{itemize}
 \item be suitable for mesh-free PDE discretizations using RBFs, i.e., produce well-separated and locally regular node sets;
 \item allow for a variable density function;
 \item be massively parallel.
\end{itemize}

\section{Matlab code}

The Git repository containing Matlab code is available at  \texttt{\url{https://github.com/OVlasiuk/3dRBFnodes.git}}.

\section{Unit cube}

Suppose the local node density is prescribed by a bounded function on the unit cube  $\rho: \mathcal{I} =[0,1]^3 \to [-D,D]$. Throughout the rest of the argument, let $ \alpha, \beta\in\mathbb{R}\setminus\mathbb{Q} $ be a fixed pair of irrational numbers. Consider the following algorithm for generating nodes with density $ \rho $:  

\begin{enumerate}
	
	\item Partition $\mathcal{I}$ into $N_\text{c}^3$ subcubes of side length $1/N_\text{c}$. Set $n_\text{max}$ to be the maximum number of nodes in each subcube of the initial distribution. \\
	(The choice of $N_\text{c}$ corresponds to the  density resolution of the final node set. The function $ \rho $, numbers $N_\text{c}$  and $n_\text{max}$ can be scaled to adjust the total number of nodes $N$ as desired.) 
%	Experimentally, choosing $n_\text{max} = 20$ and $N_\text{c}$ such that there are approximately $N/10$ total cubes seems to be a good choice.
	
	\item \label{subcube}  For a fixed subcube $\cube$, let $\bar{\rho}_\cube$ be the average of the values of $\rho$ at the corners of $\cube$. Fill the subcube with an appropriate number of nodes generated by an irrationally rotated lattice,  scaled and translated to $\cube$:
	\[\bigg(\frac{i}{n_\cube}, \bigg\{\alpha\frac{i}{n_\cube}\bigg\}, \bigg\{\beta\frac{i}{n_\cube}\bigg\}\bigg), \qquad i=1\dots n_\cube, \]
	where the number of nodes in the subcube is defined as
	\[  n_\cube = \lfloor  n_\text{max}\frac{ \bar{\rho}_\cube }{D} \rfloor.  \] 
	We write $\left\{x\right\}:= x-\left\lfloor x\right\rfloor$ for the fractional part of $x$. While any irrational values of $\alpha$ and $\beta$ will give an equidistributed lattice as $n_\cube$ grows, certain values  may perform better than others. In particular, adjustments can be made to provide better distribution for small $n_\cube$. We currently use $\alpha = \sqrt{2}, \beta = \sqrt{5}$.
	
	\item Consecutively fill all the subcubes using \eqref{subcube}. Consider the subcubes for which $ \bar{\rho}_\cube =0 $; evaluate the density function on all the nodes in such subcubes and discard those where $ \rho $ is not positive.
	
	\item Perform $ m $ iterations of electrostatically repelling the nodes using $ k $ nearest neighbors of each node. The values of $ k $ and $ m $ can be adjusted to achieve desired trade-off between execution speed and local separation. Even relatively small values of $ m $ ($ \approx 15 $) produce good results. \\
	Firstly, for all nodes determine indices of the $ k $ nearest neighbors and minimal separation distance $ \delta $. 
	For the $i^{th}$ repel step, given a node $y$ with $ k $ nearest nodes $\left\{x_j\right\}_{j=1}^k$, form the weighted vector sum
	%and the nearest neighbor distance $\delta_y$
	\[x = \sum_{j=1}^{k}\frac{y-x_j}{\|y-x_j\|^{s+1}}, \]
	for some $s>3$ and move $y$ in the direction of $x$. That is,
	\[y\mapsto y + \frac{\delta}{3i}\frac{x}{\|x\|}.\]
	The $kNN$ tree is not recomputed for each repel step.
\end{enumerate}
This algorithm generates ??? nodes in ??? seconds and ($ \sim $1 million nodes) in ??? seconds.

[Insert Trui pictures]





\section{Future Work}

Several outstanding issues remain. 
\begin{itemize}
\item The generation of the lattice on each subcube should be improved. We are working on transforming the lattice so that the density varies linearly within each subcube. This would make the density of the initial point generation more accurate and fewer repulsion steps would be needed.
\item The current code does not handle general boundaries beside the cube. Ideally the node distribution restricted to the boundary should be a reasonable 2D node distribution of variable density.
\item We are working on parallelizing the repulsion steps and implementing the algorithm on a GPU.
\end{itemize}

\end{document}
